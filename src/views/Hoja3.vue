<template>
  <div class="section">
    <div>
      <Header2Component />
    </div>

    <div>
      <ExperienciaTotComponent
        :publico="publico"
        :privado="privado"
        :independiente="independiente"
        :totalAnios="totalAnios.value"
        :totalMeses="totalMeses.value"
      />
    </div>
       <FooterComponent />
  </div>
</template>

<script setup>
import { reactive, computed, watch } from "vue";
import Header2Component from "../components/Header2Component.vue";
import ExperienciaTotComponent from "../components/ExperienciaTotComponent.vue";
import FooterComponent from "../components/FooterComponent.vue";
import { useExperienciaStore } from "../stores/experienciaStore";

// ðŸ”· 1. Store y datos principales
const store = useExperienciaStore();
const experiencias = store.experiencias;

// ðŸ”· 2. Totales por categorÃ­a
const publico = reactive({ anios: 0, meses: 0 });
const privado = reactive({ anios: 0, meses: 0 });
const independiente = reactive({ anios: 0, meses: 0 });

// ðŸ”· 3. Utilidad para calcular duraciÃ³n
function calcularDuracion({ ingreso, retiro }) {
  const desde = new Date(`${ingreso.anio}-${ingreso.mes}-${ingreso.dia}`);
  const hasta = new Date(`${retiro.anio}-${retiro.mes}-${retiro.dia}`);

  if (isNaN(desde) || isNaN(hasta) || hasta < desde)
    return { anios: 0, meses: 0 };

  let anios = hasta.getFullYear() - desde.getFullYear();
  let meses = hasta.getMonth() - desde.getMonth();
  if (hasta.getDate() < desde.getDate()) meses--;
  if (meses < 0) {
    anios--;
    meses += 12;
  }

  return { anios, meses };
}

// ðŸ”· 4. Modularizar la acumulaciÃ³n por tipo
function acumularPorTipo(tipo, meses) {
  const destino = { publica: publico, privada: privado, independiente: independiente }[tipo];
  if (!destino) return;
  const total = destino.meses + meses;
  destino.anios = Math.floor((destino.anios * 12 + total) / 12);
  destino.meses = (destino.anios * 12 + total) % 12;
}

// ðŸ”· 5. Recalcular totales globales
function recalcularTotales() {
  publico.anios = publico.meses = 0;
  privado.anios = privado.meses = 0;
  independiente.anios = independiente.meses = 0;

  experiencias.forEach((exp) => {
    const { anios, meses } = calcularDuracion(exp);
    const totalMeses = anios * 12 + meses;
    acumularPorTipo(exp.tipo, totalMeses);
  });
}

// ðŸ”· 6. Totales computados finales
const totalAnios = computed(() =>
  publico.anios + privado.anios + independiente.anios +
  Math.floor((publico.meses + privado.meses + independiente.meses) / 12)
);

const totalMeses = computed(() =>
  (publico.meses + privado.meses + independiente.meses) % 12
);

// ðŸ”· 7. Watch reactivo
watch(experiencias, recalcularTotales, { deep: true });
</script>


<style>

</style>
